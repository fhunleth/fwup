#!/bin/bash

#
# Test streaming a firmware update through fwup.
# This simulates the case where there's no local storage to hold
# the firmware update while it is being applied.
#

. ./common.sh

cat >$CONFIG <<EOF
file-resource subdir/TEST {
	host-path = "${TESTFILE_1K}"
}

task complete {
	on-resource subdir/TEST { raw_write(1) }
}
EOF

# Create the firmware file like normal
$FWUP_CREATE -c -f $CONFIG -o $FWFILE

# Pipe the contents of the firmware file through fwup
cat $HOST_FWFILE | $FWUP_APPLY -a -d $IMGFILE -i - -t complete

# The firmware file is equivalent to the following dd call
dd if=$HOST_TESTFILE_1K seek=1 of=$WORK/check.bin 2>/dev/null
diff $WORK/check.bin $HOST_IMGFILE
