#!/bin/sh

#
# Test saving the size of a resource to an Variable
#

. ./common.sh

export ACTUAL_SIZE_FILE=$WORK/actual_size.txt
export EXPECTED_SIZE_FILE=$WORK/expected_size.txt

cat >$EXPECTED_SIZE_FILE <<EOF
1024 
EOF

cat >$CONFIG <<EOF
file-resource TEST {
    host-path = "${TESTFILE_1K}"
}

file-resource-size(FILE_SIZE,"${TESTFILE_1K}")

task complete {
	on-finish { execute("echo \${FILE_SIZE} > \${ACTUAL_SIZE_FILE}") }
}
EOF

# Create the firmware file like normal
$FWUP_CREATE -c -f $CONFIG -o $FWFILE

# Apply the firmware and verify that the local file was copied
$FWUP_APPLY --unsafe -a -d $IMGFILE -i $FWFILE -t complete
diff -w $EXPECTED_SIZE_FILE $ACTUAL_SIZE_FILE

