#!/bin/sh

#
# Test U-boot redundant env support for unsetting variables
#

. "$(cd "$(dirname "$0")" && pwd)/common.sh"


# Create a starter uboot environment block
# This is created by running:
#
# $ printf "d=4\na=1\nb=2\nc=3" | mkenvimage -r -s "512" - | base64
base64_decode >$WORK/starting-uboot-env.img <<EOF
OPKIygFkPTQAYT0xAGI9MgBjPTMAAP//////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////8=
EOF

cat >$CONFIG <<EOF
define(UBOOT_ENV_OFFSET, 0)
define(UBOOT_ENV_REDUND_OFFSET, 1)

file-resource uboot-env.img {
    host-path = "$WORK/starting-uboot-env.img"
}

uboot-environment uboot-env {
    block-offset = \${UBOOT_ENV_OFFSET}
    block-count = 1
    block-offset-redund = \${UBOOT_ENV_REDUND_OFFSET}
}

task complete {
    on-resource uboot-env.img {
        raw_write(\${UBOOT_ENV_OFFSET})
    }

    on-finish {
       uboot_unsetenv(uboot-env, "a")
       uboot_unsetenv(uboot-env, "c")
       uboot_unsetenv(uboot-env, "nonexistent")  # shouldn't fail
    }
}
EOF

# Create the expected result from setting the variables. fwup ensures
# that the variables are sorted when it writes them out, so this ordering
# is guaranteed.
#
# To recreate, run:
#
# printf "b=2\nd=4" | mkenvimage -r -s "512" - | base64
#
# then manually change byte number 4 to value 0x04
#
base64_decode >$WORK/expected-env.img <<EOF
YzgQ9ARiPTIAZD00AAD/////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////8=
EOF

# Create the firmware file, then "burn it"
$FWUP_CREATE -c -f $CONFIG -o $FWFILE
$FWUP_APPLY -a -d $IMGFILE -i $FWFILE -t complete

cmp_bytes 512 $WORK/expected-env.img $IMGFILE 0 512

